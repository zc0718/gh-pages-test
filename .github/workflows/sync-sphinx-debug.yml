name: Debug Sync Sphinx

on:
  workflow_dispatch

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout AA repo
        uses: actions/checkout@v4

      - name: Setup SSH for AA
        run: |
          mkdir -p "$HOME/.ssh"
          echo "$TEST_REPO_SYNC" > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"
          ssh-keyscan github.com >> "$HOME/.ssh/known_hosts"
          
          ssh-keygen -lf "$HOME/.ssh/id_ed25519"

        env:
          TEST_REPO_SYNC: ${{ secrets.test_repo_sync }}

      - name: Clone AA and copy docs/sphinx/
        run: |
          git clone --depth=1 git@github.com:zc0718/.test.git cache-tmp
          ls -la cache-tmp/docs/
          mkdir -p docs/
          rsync -av -delete cache-tmp/docs/sphinx/ docs/sphinx
          rm -rf cache-tmp

      - name: Show changes
        run: |
          git status
          git diff --staged || echo "No staged changes."

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@user.noreply.github.com"
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "chore: debug sync docs/sphinx from AA"
            git push
            echo "Changes pushed!"
          else
            echo "No changes detected."
          fi
